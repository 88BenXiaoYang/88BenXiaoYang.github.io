---
title: 微信小程序
date: 2019-02-07 11:34:46
tags: 前端
categories: 前端
---

### 背景

当微信中的`WebView`逐渐成为移动`Web`的一个重要入口时，微信就有相关的`JS API`了。为了使在微信中对网页的开发简洁、高效，微信在`2015`年发布了一整套**网页开发工具包`JS-SDK`**，让开发者可以使用到微信的原生能力。

`JS-SDK`解决了**移动网页**能力不足的问题，通过暴露微信的接口使得`Web`开发者能够拥有更多的能力，然而在更多的能力之外，`JS-SDK`的模式并没有解决使用移动网页遇到的体验不良的问题。

使用移动网页遇到的体验不良问题，有：

1. 白屏过程(在移动端，受限于设备性能和网络速度，白屏会更加明显。有微信`Web`资源离线存储的解决方案)
   * 微信`Web`资源离线存储是面向`Web`开发者提供的基于微信内的`Web`加速方案：通过使用微信离线存储，`Web`开发者可借助微信提供的资源存储能力，直接从微信本地加载`Web`资源而不需要再从服务端拉取，从而减少网页加载时间，为微信用户提供更优质的网页浏览体验。每个公众号下所有`Web App`累计最多可缓存`5M`的资源
   * 简单的页面通过**离线存储**能够解决白屏问题，但对于复杂页面(如页面加载了大量的`CSS`或是`JavaScript`文件)，依然会有白屏问题，因为构建复杂页面的文件的执行时间占用了大量的`UI`线程
2. 缺少操作的反馈，主要表现在：
   * 页面切换的生硬
   * 点击的迟滞感

为解决上述的用户体验问题，使开发者对移动网页的开发简洁、高效，全新的系统小程序应运而生。小程序具有以下特点：

* 快速的加载
* 更强大的能力
* 原生的体验
* 易用且安全的微信数据开放
* 高效和简单的开发

### 小程序与普通网页开发的区别

小程序的主要开发语言是`JavaScript`

网页开发**渲染线程**和**脚本线程**是互斥的，这也是为什么长时间的脚本运行可能会导致页面失去响应，而在小程序中，二者是分开的，分别运行在不同的线程中。网页开发者可以使用到各种**浏览器暴露出来的`DOM API`**，进行`DOM`选中和操作。小程序的**逻辑层**和**渲染层**是分开的，逻辑层运行在`JSCore`中，并没有一个完整**浏览器对象**，因而缺少相关的`DOM API`和`BOM API`。这一区别导致了前端开发非常熟悉的一些库，例如`jQuery`、`Zepto`等，在小程序中是无法运行的。同时`JSCore`的环境同`NodeJS`环境也是不尽相同，所以一些`NPM`的包在小程序中也是无法运行的。

**网页开发**者需要面对的环境是各式各样的**浏览器**，`PC`端需要面对`IE`、`Chrome`、`QQ`浏览器等，在移动端需要面对`Safari`、`Chrome`以及`iOS`、`Android`系统中的各式`WebView`。而小程序开发过程中需要面对的是两大操作系统`iOS`和`Android`的微信客户端，以及用于辅助开发的小程序开发者工具，小程序中三大运行环境也是有所区别的，区别如下：

![小程序的运行环境](微信小程序/小程序的运行环境.png)

### 小程序代码组成

小程序由配置代码`JSON`文件、模板代码`WXML`文件、样式代码`WXSS`文件以及**逻辑代码**`JavaScript`文件组成。

##### `JSON`配置

`JSON`是一种数据格式，并不是编程语言。在小程序中`.json`为后缀的`JSON`文件是配置文件。

`JSON`文件在小程序代码中扮演静态配置的作用，在小程序运行之前就决定了小程序一些表现，需要注意的是小程序是无法在运行过程中去动态更新`JSON`配置文件从而发生对应变化的。

* `JSON`语法

通过`key-value`的方式来表达数据，`JSON`中键和值都用双引号包裹。`JSON`文件中无法使用注释，添加注释将会引发报错。

* `JSON`的值只能是以下几种数据格式
  1. 数字，包含浮点数和整数
  2. 字符串，需要包裹在双引号中
  3. `Bool`值，`true`或者`false`
  4. 数组，需要包裹在方括号中`[]`
  5. 对象，需要包裹在大括号中`{}`
  6. `Null`

  

**小程序配置 app.json**

`app.json` 是当前小程序的**全局配置**，包括了小程序的：

```
所有页面路径、
界面表现、
网络超时时间、
底部 tab 等。
```

主要配置项的含义：

```
pages - 用于指定小程序由哪些页面组成，每一项都对应一个页面的 路径+文件名 信息。
文件名不需要写文件后缀，框架会自动去寻找对应位置的 .json, .js, .wxml, .wxss 四个文件进行处理。

pages配置项的值是数组，数组的第一项代表小程序的初始页面（首页）。小程序中新增/减少页面，都需要对 pages 数组进行修改。

tabBar - 指定 tab 栏的表现，以及 tab 切换时显示的对应页面。
其中 tabBar 的 list 属性接受一个数组，只能配置最少 2 个、最多 5 个 tab。tab 按数组的顺序排序，每个项都是一个对象。
```

配置项细节可参考[小程序的配置 app.json](https://developers.weixin.qq.com/miniprogram/dev/framework/config.html)

**工具配置 project.config.json**

使用场景：开发者在小程序开发者工具上做的任何配置都会写入到这个文件，当重新安装工具或换电脑时，只要载入同一个项目的代码包，开发者工具就自动会帮你恢复到之前开发项目时的个性化配置。

配置项细节可参考[开发者工具的配置](https://developers.weixin.qq.com/miniprogram/dev/devtools/projectconfig.html)

**页面配置 page.json**

这类配置是`pages/xxx`目录下和小程序页面相关的配置。让开发者可以独立定义每个页面的属性，如顶部颜色、是否允许下拉刷新。

页面的配置只能设置`app.json`中部分`window`配置项的内容，页面中配置项会覆盖`app.json`的`window`中相同的配置项。

配置项细节可参考[页面配置](https://developers.weixin.qq.com/miniprogram/dev/framework/config.html#页面配置)

##### `.wxml`后缀的`WXML`模板文件

`WXML`全称是`WeiXin Markup Language`，是小程序框架设计的一套标签语言，结合小程序的基础组件、事件系统，可以构建出页面的结构。`WXML`要求标签必须是严格闭合的，没有闭合将会导致编译错误。

**标签**可以拥有**属性**，属性提供了有关的**`WXML`元素**更多信息。**属性总是定义在开始标签中**，除了一些特殊的属性外，其余**属性的格式都是key="value"的方式成对出现**。需要注意的是，`WXML`中的**属性是大小写敏感的**，也就是说`class`和`Class`在`WXML`中是不同的属性。

网页编程采用的是`HTML + CSS + JS`这样的组合，其中：

```
HTML： 是用来描述当前这个页面的结构；
CSS： 用来描述页面的样子；
JS： 通常是用来处理这个页面和用户的交互。
```

和`HTML`相似，`WXML`由标签、属性等构成。也有很多不一样的地方，区别如下：

1. 标签名字不一样：

```
写 HTML 的时候，经常会用到的标签是 div，p，span，在写一个页面的
时候可以根据这些基础的标签组合出不一样的组件，如日历、弹窗等。基于
此小程序把常用的组件包装起来，用指定的标签表示包装起来的组件，同时
被包装起来的组件拥有对应的基本能力。如小程序的 WXML 用的标签是 
view，button，text等，这些标签就是小程序给开发者包装好的基本组件
能力，除此之外微信还提供了地图、视频、音频等组件能力。
```

更多组件能力的详细信息可参考[小程序的能力](https://developers.weixin.qq.com/miniprogram/dev/quickstart/basic/framework.html)、[小程序的组件](https://developers.weixin.qq.com/miniprogram/dev/component/)

2. 多了一些`wx:if`这样的属性

```
多了一些 wx:if 这样的属性以及 {{}} 这样的表达式。

小程序中，wx:if 这样的属性和 {{}} 这样的表达式引入的背景：

在网页的一般开发流程中，通常会通过 JS 操作 DOM（对应 HTML 的描述
产生的树），以引起界面的一些变化响应用户的行为。如，用户点击某个按
钮的时候，JS 会记录一些状态到 JS 变量里边，同时通过 DOM API 操
控 DOM 的属性或者行为，进而引起界面一些变化。当项目越来越大的时
候，代码会充斥着非常多的界面交互逻辑和程序的各种状态变量，显然这不
是一个很好的开发模式，因此就有了 MVVM 的开发模式（如React，
Vue），提倡把渲染和逻辑分离。
```

**小程序框架的思路：**简单来说就是不要再让 `JS` 直接操控 `DOM`，`JS` 只需要管理状态即可，然后再通过一种**模板语法**来描述状态和界面结构的关系即可。

* 数据绑定

数据绑定实现程序运行的过程中，可以动态的去改变渲染界面。在`Web`开发中，开发者使用`JavaScript`通过`Dom`接口来完成界面的实时更新。在小程序中，使用`WXML`语言所提供的**数据绑定**功能，来完成此项功能。

{% raw %}
`WXML`通过`{{变量名}}`来绑定`WXML`文件和对应的`JavaScript`文件中的`data`对象属性。
{% endraw %}

{% raw %}
属性值也可以动态的去改变，有所不同的是，属性值必须被包裹在双引号中。需要注意的是变量名是大小写敏感的，也就是说`{{name}}`和`{{Name}}`是两个不同的变量。没有被定义的变量或者是被设置为`undefined`的变量不会被同步到`wxml`中。
{% endraw %}

* 逻辑语法

通过`{{变量名}}`语法可以使得`WXML`拥有动态渲染的能力，除此外还可以在`{{ }}`内进行简单的逻辑运算。

* `{{}}`内支持的逻辑运算：
  * 三元运算
  * 算数运算(类似于算数运算，支持字符串的拼接)
  * `{{}}`中可以直接放置数字、字符串或者是数组

* 条件逻辑

`WXML`中，使用`wx:if="{{condition}}"`来判断是否需要**渲染**该代码块。使用`wx:elif`和`wx:else`来添加一个`else`块。

因为`wx:if`是一个**控制属性**，需要将它添加到一个标签上。如果要一次性判断多个组件标签，可以使用一个`<block/>`标签将多个组件包装起来，并在上边使用`wx:if`控制属性。

* 列表渲染

在组件上使用`wx:for`控制属性绑定一个数组，即可使用数组中各项的数据重复渲染该组件。默认数组的当前项的下标变量名默认为`index`，数组当前项的变量名默认为`item`。使用`wx:for-item`指定数组当前元素的变量名，使用`wx:for-index`指定数组当前下标的变量名(相当于命名别名)。

如果需要保持列表项目的特征和状态时(如：`<input/>`中的输入内容，`<switch/>`的选中状态)，需要使用`wx:key`来指定列表中项目的唯一标识符。基于在渲染时，带有`key`的组件，框架会确保他们被重新排序，而不是重新创建，以确保使组件保持自身的状态，并且提高列表渲染时的效率。

`wx:key`的值以两种形式提供：

1. **字符串**，代表在`for`循环的`array`中`item`的某个`property`，该`property`的值需要是列表中**唯一的字符串或数字，且不能动态改变**
2. 保留关键字`this`代表在`for`循环中的`item`本身，这种表示需要`item`本身是一个唯一的字符串或者数字

* 模版

`WXML`提供模板(`template`)，可以在模板中定义代码片段，然后在不同的地方调用。使用`name`属性，作为模板的名字。然后在`<template/>`内定义代码片段。

定义模版：

```
<template name="msgItem">
  <view>
    <text> {{index}}: {{msg}} </text>
    <text> Time: {{time}} </text>
  </view>
</template>
```

使用`is`属性，声明需要使用的模板，然后将模板所需要的`data`传入。`is`可以动态决定具体需要渲染哪个模板。

* 引用

`WXML`提供两种文件引用方式`import`和`include`。

1. `import`可以在该文件中使用目标文件定义的`template`。需要注意的是`import`有作用域的概念，即只会`import`目标文件中定义的`template`，而不会`import`目标文件中`import`的`template`，简言之就是`import`不具有递归的特性
2. `include`可以将目标文件中除了`<template/>``<wxs/>`外的整个代码引入，相当于是拷贝到`include`位置

##### `.wxss`后缀的`WXSS`样式文件

`WXSS`(`WeiXin Style Sheets`)是一套用于小程序的**样式语言**，用于描述`WXML`的**组件样式**，也就是视觉上的效果。`WXSS`与`Web`开发中的`CSS`类似。

`app.wxss`为项目的公共样式，它会被注入到小程序的每个页面。页面样式，是与`app.json`注册过的页面同名且位置同级的`.wxss`文件。其他样式，可以被项目公共样式和页面样式引用。

在小程序开发中，开发者不需要像`Web`开发那样去优化样式文件的请求数量，只需要考虑**代码的组织**即可，样式文件最终会被编译优化。

在`WXSS`中，引入了`rpx`(`responsive pixel`)尺寸单位，以适配不同宽度的屏幕。小程序编译后，`rpx`会做一次`px`换算。换算是以`375`个物理像素为基准，也就是在一个宽度为`375`物理像素的屏幕下，`1rpx = 1px`。

常用机型`rpx`尺寸换算表：

![常用机型rpx尺寸换算表](微信小程序/常用机型rpx尺寸换算表.png)

由于`WXSS`最终会被**编译打包**到目标文件中，用户只需要下载一次，在使用过程中不会因为样式的引用而产生多余的文件请求。小程序中样式文件的引用格式为：`@import '.wxss文件路径'`。

小程序中`WXSS`内联样式与`Web`一样。即通过样式属性`style`进行设置。小程序支持动态更新内联样式。

小程序`WXSS`现阶段支持的选择器：

![小程序WSXX现阶段支持的选择器](微信小程序/小程序WSXX现阶段支持的选择器.png)

`WXSS`选择器优先级：

![WXSS选择器优先级](微信小程序/WXSS选择器优先级.png)

**权重越高越优先。在优先级相同的情况下，后设置的样式优先级高于先设置的样式。**

##### `.js`后缀的`JS`脚本逻辑文件
