---
title: SQL基础
date: 2019-01-26 15:10:22
tags: 数据库
categories: 数据库
---

##### 基本概念

注意：**数据库的名称只能使用小写字符。**（实际存储的命名是小写字符，如在命名时有大写字符，在实际存储的时候也会转成小写字符。在PostgreSQL上验证过）

* DBMS主要是通过**数据的保存格式**（数据库种类）来进行分类的，主要有以下五种

```
一、层次型数据库（HDB）（树形结构）
二、关系型数据库（RDB）（采用行列二维表结构来管理数据，使用专门的
SQL（structured Query Language，结构化查询语言）语言对数据进
行操作）（对应的数据库管理系统，是RDBMS，具有代表性的RDBMS有：
Oracle Database[甲骨文]、SQL Server[微软]、DB2[IBM]、
PostgreSQL[开源]、MySQL[开源] ）
三、面向对象数据库（OODB）
四、XML数据库（XMLDB）
五、键值存储系统（Key-Value Store，KVS）
```

关系数据库采用被称为数据库表的二维表来管理数据。用来管理数据的二维表在关系数据库中简称为表，表存储在由RDBMS管理的数据库中，一个数据库中可以存储多个表。

数据库表由表示数据项目的列（字段）和表示一条数据的行（记录）所组成，以记录为单位进行数据读写。（每个字段值[行列交汇的单元格]，只能输入一个数据）

根据SQL语句的内容返回的数据，同样必须是二维表的形式。

* 操作关系数据库表的法则

```
1、关系数据库必须以行为单位进行数据读写
2、在一个单元格中只能输入一个数据
```

* SQL语句的书写规则

```
1、SQL语句要以分号（;）结尾
2、SQL语句不区分大小写（SQL不区分关键字的大小写）
2.1 关键字大写
2.2 表名的首个字母大写
2.3 其余（列名等）小写
3、常数的书写方式是固定的。SQL中的常数，是在SQL语句中直接书写的字
符串、日期或者数字等称为常数。字符串、日期常数需要使用单引号（'）
括起来，数字常数直接书写即可。
4、单词需要用半角空格或者换行来分隔。
```

* SQL语句的命名规则

```
1、只能使用半角英文字母、数字、下划线作为数据库、表和列的名称；
2、名称必须以半角英文字母开头；
3、名称不能重复。
```

* 安全

```
为了防止重要数据被窃读或篡改，RDBMS只允许注册用户接触数据库。
```

* 补充

```
1、所有的列都必须指定数据类型。
2、约束，是除了数据类型之外，对列中存储的数据进行限制或者追加条件的功能。
```

##### 基本操作

* 常用指令

```
创建数据库：create database 数据库名称
删除数据库：drop database 数据库名称
查看已创建的数据库：
select * from pg_database;（postgreSQL下）
show databases;//查看有哪些数据库（MySQL）

查看数据库中已建的表：
select tablename from pg_tables where schemaname='public’;
use databaseName;//指定使用哪个数据库（MySQL）
show tables;//查看指定数据库下都有哪些表（MySQL）
```

* 运算符

```
所有包含NULL的计算，结果肯定是NULL。
（通常情况下除数为零的式子会出错，但有NULL的除法运算中，除数为零时式子不会出错，并且结果为NULL）

大于等于（>=）、小于等于（<=）：不等号在左，等号在右
不等号：<>

SQL不识别“= NULL”和“<> NULL”，对应的运算符是：IS NULL和 IS NOT NULL。

SQL中的逻辑运算是包含对真、假和不确定进行运算的三值逻辑。

逻辑运算结果是真值。（真值就是值为真或假其中之一的值）

算术运算符返回的结果是数字。
```

* 运算符优先级：`and运算优先于or运算执行`

SQL中的逻辑，是三值逻辑（包括真、假、不确定），因加入不确定后，运算结果会比较复杂，所以在建表时，会对相应列进行NOT NULL约束。

聚合函数会将NULL排除在外。但count(*)例外，并不会排除NULL。

```
MAX/MIN函数几乎适用于所有数据类型的列，
SUM/AVG函数只适用于数值类型的列。
```

通常select语句执行结果的显示顺序都是随机的，想要按照某种特定顺序进行排序，需要在select语句中进行指定。

* 子句

```
只有select子句和having子句（以及order by子句）中能够使用聚合函数。

where子句用来指定数据行的条件，having子句用来指定分组的条件。

select子句的执行顺序在group by子句之后，在order by子句之前。
```

* 子句的书写顺序

```
1、select子句->2、from子句->3、where子句->4、group by子句->5、having子句->6、order by子句
```

* select语句的顺序

```
from->where->group by->having->select->order by
```

默认值的设定，可以通过在创建表的create table语句中设置default约束来实现。

##### 事务

`事务，是数据库中用来管理数据更新的重要概念。`

数据库事务(Database Transaction)，是指作为单个逻辑工作单元执行的一系列操作，要么完整的执行，要么完全不执行。事务处理可以确保除非事务性单元内的所有操作都成功完成，否则不会永久更新面向数据的资源。通过将一组相关操作组合为一个要么全部成功，要么全部失败的单元，可以简化错误恢复并使应用程序更加可靠。一个逻辑工作单元要成为事务，必须满足ACID(原子性、一致性、隔离型和持久性)属性。

**事务是需要在同一个处理单元中执行的一系列更新处理的集合。**事务代表了对表中数据进行更新的单位。通过使用事务，可以对数据库中的数据更新处理的提交和取消进行管理。**数据库的更新操作以事务为单位进行。**

* 事务的特性

事务具有ACID特性：

```
原子性（Atomicity）；
一致性（Consistency）；
隔离性（Isolation）；
持久性（Durability）。
```

```
原子性：事务中的操作要么都执行，要么都不执行（反映到对数据库操作的
最终结果上。即一个事务完成后，对结果的操作不可撤销，结果不可恢复到
操作前的状态，即与持久性相对应！！！）

一致性：指的是事务中包含的处理，要满足数据库提前设置的约束。即针对
对应字段域的处理，要满足建表时对该字段域所设置的约束，即保证新的操
作与原有数据类型的完整性。如操作过程中有失败的情况，会撤销当前失败
的操作，回滚到上一次操作成功完成后的状态，随后继续执行后续的操作。

隔离性：指的是保证不同事务之间互不干扰的特性。在事务未提交之前，该
事务中的操作对其他事务而言是不可见的。

持久性：指的是事务（不论是提交还是回滚）一旦结束，DBMS会保证该时点
的数据状态得以保存的特性。
```

**DBMS的事务都遵循ACID标准规格的约定！！！**

遇到需要在同一个处理单元中执行一系列更新操作的情况，一定要使用事务来进行处理。进行数据库更新操作，有事务的环境下，才能进行撤销或确认操作。使用事务开始语句和事务结束语句，将一系列DML语句（insert/update/delete语句）括起来，就实现了一个事务处理。

事务处理的终止指令包括commit（提交处理）和rollback（取消处理）两种。

* 事务的常用模式

**注：实际上，几乎所有的数据库产品的事务都无需开始指令。这是因为大部分情况下，事务在数据库连接建立时就已经悄悄开始了，并不需要用户再明确发出开始指令。**

像这样不使用指令而悄悄开始事务的情况下，应该如何区分各个事务呢？通常会有如下两种情况：

```
一、每条SQL语句就是一个事务（自动提交模式）
二、直到用户执行commit或者rollback为止算作一个事务
```

通常的DBMS都可以选择其中任意一种模式。

```
默认使用自动提交模式的DBMS有：SQL Server、PostgreSQL和MySQL；
默认使用第二种模式的有Oracle。
```

自动提交的模式可关闭，在关闭自动提交模式的情况下，可以通过事务开始语句，明示开始事务，相应的需要事务结束语句，明示结束事务。

* 小结
  * 事务(Transaction)是数据库操作中并发控制的单位，是用户定义的一个操作序列。这些操作要么都做，要么都不做，是一个不可分割的工作单位。通过事务，SQL Server能将逻辑相关的一组操作绑定在一起，以便服务器保持数据的完整性
  * 事务通常是以BEGIN TRANSACTION开始，以COMMIT或ROLLBACK结束
     * COMMIT表示提交，即提交事务的所有操作。具体说就是将事务中所有对数据库的更新写回到磁盘上的物理数据库中去，事务正常结束(在提交前，操作的数据结果可能是存到缓存中)
     * ROLLBACK表示回滚，即在事务执行的过程中发生了某种故障，事务不能继续进行，系统将事务中对数据库的所有已完成的操作全部撤销，回滚到事务开始的状态
     * 如果事务没有错误则提交(COMMIT Transaction)，如果出现错误或死机则回滚事务(ROLLBACK)
  * 事务运行的三种模式
     * 自动提交事务：每条单独的语句都是一个事务，每个语句后都隐含一个COMMIT
     * 显式事务：以BEGIN TRANSACTION显式开始，以COMMIT或ROLLBACK显式结束
     * 隐式事务：在前一个事务完成时，新事务隐式启动，但每个事务仍以COMMIT或ROLLBACK显式结束

##### 视图和表

* 视图的概念

从SQL的角度来看，视图和表是相同的。两者的区别（仅有的区别）在于表中保存的是实际的数据，而视图中保存的是select语句（视图本身并不存储数据）。视图是一个工具。使用视图，可以完成跨多表查询数据等复杂操作。**实际上视图保存的是select语句（从视图中读取数据时，视图会在内部执行select语句并创建出一张临时表）。**视图归根到底就是select语句，所谓“参照视图”也就是“执行select语句”的意思。因此可以保证数据的最新状态。

* 数据存储过程

通常，在创建表时，会通过insert语句将数据保存到数据库中。而数据库中的数据实际上会被保存到计算机的存储设备（通常是硬盘）中。因此，通过select语句查询数据时，实际上就是从存储设备（硬盘）中读取数据，进行各种计算之后，将结果返回给用户。

* 视图的优点

一、节省存储设备的数据领域。

二、将频繁使用的select语句保存成视图（类似创建快捷键），有利于提高效率。

**注：视图中的数据会随着原表的变化自动更新。**

* 一幅视图

```
查看数据库中已建的视图：
select viewname from pg_views where schemaname='public';
```

* 视图的操作

视图和表需要同时进行更新，因此通过聚合得到的视图无法进行更新。使用cascade选项来删除关联视图，会把目标视图，和与之相关联的视图都删除。

子查询就是一次性的视图（select语句）。与视图不同，子查询在select语句执行完毕之后就会消失。子查询的特点概括起来就是一张一次性视图。

通常指定关联子查询作为exist的参数。

##### 函数

`函数，就是输入某一值得到相应输出结果的功能（SQL自带有便利的工具---函数），具体表现有：类的方法。`

聚合函数基本上只包含`count、sum、avg、max、min`这5种。

* 算术函数：除常用的加减乘除还有以下函数

```
abs（absolute values，绝对值函数），语法：abs（数值）

mod（modulo的简称），是计算除法余数（剩余）的函数，语法：mod（被
除数，除数）（被除数写在根号里）（如：7/3的余数是1，因此mod（7，
3）的结果也是1）。由于小数计算中并没有余数的概念，所以只能对整数类
型的列使用mod函数。

注：主流的DBMS都支持mod函数，只有SQL Server不支持该函数，SQL 
Server用运算符（%）来实现等价的效果（SQL Server：7%3=1）

round（四舍五入函数），语法：round（对象数值，保留小数的位数）
（如指定四舍五入的位数为1，那么就会对小数点第2位进行四舍五入处理；
如指定位数为2，那么就会对小数点第3位进行四舍五入处理）
```

* 字符串函数

```
拼接函数（||函数），语法：str1 || str2 = str1str2。进行字符串
拼接时，如果其中包含null，那么得到的结果也是null，因为“||”也是变了形的函数。
SQL Server和MySQL中，“||”函数无效，对应的等价函数是：SQL 
Server是“+”；MySQL是concat(字符串1，字符串2，...)。

字符串长度函数（length函数），语法：length（字符串）
SQL Server中，length函数无效，对应的等价函数是：len（字符串）

小写转换函数（lower），语法：lower（字符串）；大写转换函数（upper）

字符串替换函数（replace），语法：replace（对象字符串，替换前的字符串，替换后的字符串）

字符串截取函数（substring），语法：
substring（对象字符串 from 截取的起始位置 for 截取的字符数）（PostgreSQL/MySQL）
substring（对象字符串，截取的起始位置，截取的字符数）（SQL Server）
substr（对象字符串，截取的起始位置，截取的字符数）（Oracle/DB2）
```

##### 谓词

**谓词，就是返回值为真值的函数。**谓词是SQL的抽出条件中不可或缺的工具。谓词是需要满足特定条件的函数，该条件就是“返回值是真值”。谓词的返回值全都是真值（true/false/unknown）。

like谓词：字符串的部分一致查询（%，代表“0字符以上的任意字符串”的特殊符号）（可用“_”代替“%”，与“%”不同的是其代表了“任意1个字符”）。

between谓词：范围查询。

is null、is not null谓词：判断是否为null。

in谓词：or的简便用法。

**谓词的作用是“判断是否存在满足某种条件的记录”。**

##### 集合运算

**集合运算符会除去重复的记录。**

* 集合运算的注意事项

```
一：作为运算对象的记录的列数必须相同；
二：作为运算对象的记录中列的类型必须一致；
三：可以使用任何select语句，但order by子句只能在最后使用一次。
```

##### 其它

表达式可以书写在任意位置。

case表达式无论多长都是一个表达式。

**外联结有一点非常重要，那就是要把哪张表作为主表，最终的结果中会包含主表内所有的数据。**